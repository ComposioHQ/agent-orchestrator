# Agent Orchestrator — vibe config

dataDir: ~/.ao
worktreeDir: ~/.worktrees
port: 3000

defaults:
  runtime: tmux
  agent: claude-code
  workspace: worktree
  notifiers: [desktop]

projects:
  blog:
    name: AI Content Factory Blog
    repo: moneymaker-ux/blog
    path: ~/BLOG
    defaultBranch: main
    sessionPrefix: blog
    symlinks: [.claude]
    agentConfig:
      permissions: skip

  evasmm:
    name: EVASMM.io
    repo: moneymaker-ux/EVASMM.io
    path: ~/EVASMM.io
    defaultBranch: develop
    sessionPrefix: evasmm
    symlinks: [.claude]
    agentConfig:
      permissions: skip
    orchestratorRules: |-
      You are the orchestrator for EVASMM.io project.
      Your job:
      1. Review open GitHub Issues: gh issue list --repo moneymaker-ux/EVASMM.io --state open
      2. Prioritize by phase number (Phase 7 before Phase 8, etc.)
      3. Spawn worker agents for issues: ao spawn evasmm <issue#>
      4. Monitor progress with tmux capture-pane (NOT ao status alone)
      5. Handle stuck agents: ao send <session> "instructions"
      6. Do NOT write code yourself — only coordinate workers
      7. Max 3 concurrent agents to avoid overwhelming the system
      8. All PRs target develop branch

      ## PRE-FLIGHT (MANDATORY before EVERY spawn)
      Before spawning ANY agent, check all 3:
      1. gh issue view <N> --json state        # CLOSED? → SKIP
      2. gh pr list --json headRefName          # PR exists? → SKIP
      3. git fetch origin && git log origin/develop --oneline -10  # Already merged? → SKIP
      If ANY check shows work is done — DO NOT spawn. Move to next issue.

      ## MONITORING LOOP (MANDATORY)
      After spawning agents, you MUST run a monitoring loop:

      FIRST CHECK (20 seconds after spawn):
      1. Wait: sleep 20
      2. For EACH spawned session — verify it started:
         tmux capture-pane -t <tmux-session-name> -p | tail -20
      3. If agent is idle or hasn't started — nudge: ao send <session> "Start working on your assigned issue. Follow the full cycle: code → verify → commit → push → PR"
      4. Wait another 20 seconds: sleep 20
      5. Check again with tmux capture-pane. If STILL not working — kill and respawn: ao session kill <session> && ao spawn evasmm <issue#>
      6. If all agents are running — proceed to regular loop

      REGULAR LOOP (every 2 minutes):
      1. Check each active session with: tmux capture-pane -t <session> -p | tail -30
      2. Also verify process alive: ps -p <PID> -o pid,%cpu,etime
      3. Check remote branches: git ls-remote origin 'refs/heads/feat/issue-*'
      4. Check PRs: gh pr list --state open --repo moneymaker-ux/EVASMM.io
      5. If stuck or idle too long — nudge: ao send <session> "continue"
      6. If PR is open and CI green — proceed to auto-merge
      7. If PR has CI failures — send: ao send <session> "CI failed, fix and push"
      8. Wait 2 minutes: sleep 120
      9. Repeat from step 1

      NEVER trust "ao status" alone — it shows "ready" for working agents.
      NEVER kill agent without: ps check + remote branch check + PR check (all 3).
      NEVER say "let's wait 10 minutes" — check NOW, report every 2-3 min.
      Stop the loop ONLY when ALL sessions have merged PRs or are killed.

      ## AUTO-MERGE (when agents are done)
      When ALL spawned agents have finished (PRs open, CI green):
      1. For each open PR targeting develop:
         - Verify CI checks passed: gh pr checks <pr#> --repo moneymaker-ux/EVASMM.io
         - If ALL checks green — merge: gh pr merge <pr#> --repo moneymaker-ux/EVASMM.io --squash --delete-branch
         - If checks failed — send agent to fix or fix manually
      2. After merging ALL PRs — report completion summary
      3. Cleanup: ao session cleanup
    agentRules: |-
      ## MANDATORY: Fresh Code Before Work
      Before writing ANY code:
        git fetch origin && git rebase origin/develop

      ## MANDATORY: Commit Early, Push Often
      Agent crash rate is ~80% before first commit. To prevent work loss:
      1. After writing first 2-3 files → git add + git commit immediately
      2. Push after first commit → git push origin <branch>
      3. Continue working → additional commits as needed
      4. Create PR last → only after all work is committed and pushed
      NEVER wait until "everything is done" to commit.

      ## VERIFICATION (must ALL pass before push)
      Frontend (EXACT script names!):
        cd frontend && npm ci && npm run type-check && npm test && npm run build
      Backend:
        cd backend && source .venv/bin/activate && python -m pytest -v
      If verification fails and it's YOUR bug → fix it.
      If verification fails due to external deps → document in PR and push anyway.

      ## COMMITS & PRs
      Use conventional commits (feat:, fix:, chore:, docs:, refactor:, test:).
      Link issue: "feat: add bot webhook handler (#61)"
      Every PR body must include "Closes #<N>" to auto-close the issue.
      One PR per issue unless told otherwise.
      PR base branch: develop (NOT main).

      ## STRICT RULES
      Push ONLY after verification passes.
      If stuck — report the problem, do NOT silently stop.
      Only modify files related to YOUR issue — stay in your lane.
      Use EXACT script names from package.json (type-check, NOT typecheck).

reactions:
  ci-failed:
    auto: true
    action: send-to-agent
    retries: 2
  changes-requested:
    auto: true
    action: send-to-agent
    escalateAfter: 30m
  approved-and-green:
    auto: false
    action: notify
